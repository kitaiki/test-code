<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>간단한 Polygon Split 예제</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        canvas {
            border: 2px solid #333;
            background-color: #f8f9fa;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 12px 24px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend-color {
            width: 24px;
            height: 24px;
            border: 2px solid #333;
            border-radius: 4px;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .result {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #333;">Polygon을 Line으로 분할하기</h1>
        
        <div class="info">
            <h3>🎯 사용법:</h3>
            <ol>
                <li><strong>폴리곤 생성</strong>: 캔버스를 클릭해서 다각형의 꼭짓점을 만들고, 시작점을 다시 클릭해서 폴리곤을 완성하세요</li>
                <li><strong>분할선 그리기</strong>: 폴리곤을 가로지르는 직선을 그으세요 (시작점과 끝점 클릭)</li>
                <li><strong>분할 실행</strong>: 자동으로 폴리곤이 두 개로 분할됩니다</li>
                <li><strong>초기화</strong>: 모든 도형을 지우고 다시 시작합니다</li>
            </ol>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(255, 0, 0, 0.3); border-color: red;"></div>
                <span>원본 폴리곤</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: blue;"></div>
                <span>분할선</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(0, 255, 0, 0.3); border-color: green;"></div>
                <span>분할된 영역 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(255, 165, 0, 0.3); border-color: orange;"></div>
                <span>분할된 영역 2</span>
            </div>
        </div>

        <div class="controls">
            <button id="drawPolygon">폴리곤 그리기</button>
            <button id="drawLine" disabled>분할선 그리기</button>
            <button id="splitPolygon" disabled>분할 실행</button>
            <button id="clear">초기화</button>
        </div>

        <div class="status" id="status">폴리곤 그리기 버튼을 클릭하여 시작하세요</div>

        <canvas id="canvas" width="800" height="600"></canvas>
        
        <div id="result" class="result">
            <h3>✅ 결과:</h3>
            <p id="resultText"></p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const resultText = document.getElementById('resultText');

        // 버튼들
        const drawPolygonBtn = document.getElementById('drawPolygon');
        const drawLineBtn = document.getElementById('drawLine');
        const splitPolygonBtn = document.getElementById('splitPolygon');
        const clearBtn = document.getElementById('clear');

        // 상태 관리
        let mode = 'none'; // 'polygon', 'line', 'none'
        let polygon = [];
        let splitLine = null;
        let splitPolygons = [];
        let isDrawingPolygon = false;
        let isDrawingLine = false;
        let lineStart = null;

        // 기하학적 계산 함수들
        function pointInPolygon(point, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                if (((polygon[i].y > point.y) !== (polygon[j].y > point.y)) &&
                    (point.x < (polygon[j].x - polygon[i].x) * (point.y - polygon[i].y) / (polygon[j].y - polygon[i].y) + polygon[i].x)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        function lineIntersection(p1, p2, p3, p4) {
            const denom = (p1.x - p2.x) * (p3.y - p4.y) - (p1.y - p2.y) * (p3.x - p4.x);
            if (Math.abs(denom) < 1e-10) return null;

            const t = ((p1.x - p3.x) * (p3.y - p4.y) - (p1.y - p3.y) * (p3.x - p4.x)) / denom;
            const u = -((p1.x - p2.x) * (p1.y - p3.y) - (p1.y - p2.y) * (p1.x - p3.x)) / denom;

            if (t >= 0 && t <= 1 && u >= 0 && u <= 1) {
                return {
                    x: p1.x + t * (p2.x - p1.x),
                    y: p1.y + t * (p2.y - p1.y)
                };
            }
            return null;
        }

        function getPolygonLineIntersections(polygon, line) {
            const intersections = [];
            
            // 폴리곤의 모든 엣지 검사 (마지막 점과 첫 번째 점 연결 포함)
            for (let i = 0; i < polygon.length; i++) {
                const p1 = polygon[i];
                const p2 = polygon[(i + 1) % polygon.length]; // 마지막 점은 첫 번째 점과 연결
                
                const intersection = lineIntersection(p1, p2, line.start, line.end);
                if (intersection) {
                    // 중복 교차점 제거 (같은 위치의 점들)
                    const isDuplicate = intersections.some(existing => 
                        distance(existing.point, intersection) < 5
                    );
                    
                    if (!isDuplicate) {
                        intersections.push({
                            point: intersection,
                            edgeIndex: i,
                            edgeStart: p1,
                            edgeEnd: p2
                        });
                    }
                }
            }
            return intersections;
        }

        function splitPolygonByLine(polygon, line) {
            const intersections = getPolygonLineIntersections(polygon, line);
            
            console.log('교차점 개수:', intersections.length);
            console.log('교차점들:', intersections);
            
            if (intersections.length < 2) {
                console.log('교차점이 부족합니다. 분할선이 폴리곤을 완전히 가로지르지 않습니다.');
                return null;
            }
            
            if (intersections.length > 2) {
                console.log('교차점이 너무 많습니다. 가장 적절한 2개만 선택합니다.');
                // 분할선 상에서 가장 먼 2개 점 선택
                intersections.sort((a, b) => {
                    const distA = distance(line.start, a.point);
                    const distB = distance(line.start, b.point);
                    return distA - distB;
                });
                intersections.splice(2); // 처음 2개만 유지
            }

            // 교차점을 엣지 인덱스 순으로 정렬
            intersections.sort((a, b) => a.edgeIndex - b.edgeIndex);
            
            const [int1, int2] = intersections;
            
            console.log('선택된 교차점:', int1, int2);

            // 두 개의 새로운 폴리곤 생성
            const poly1 = [];
            const poly2 = [];

            // 첫 번째 폴리곤: 시작부터 첫 번째 교차점까지, 그리고 두 번째 교차점부터 끝까지
            for (let i = 0; i <= int1.edgeIndex; i++) {
                poly1.push(polygon[i]);
            }
            poly1.push(int1.point);
            poly1.push(int2.point);
            
            for (let i = int2.edgeIndex + 1; i < polygon.length; i++) {
                poly1.push(polygon[i]);
            }

            // 두 번째 폴리곤: 첫 번째 교차점부터 두 번째 교차점까지
            poly2.push(int1.point);
            for (let i = int1.edgeIndex + 1; i <= int2.edgeIndex; i++) {
                poly2.push(polygon[i]);
            }
            poly2.push(int2.point);

            console.log('분할된 폴리곤 1:', poly1);
            console.log('분할된 폴리곤 2:', poly2);

            return [poly1, poly2];
        }

        function distance(p1, p2) {
            return Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
        }

        // 그리기 함수들
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function drawPolygonShape(points, fillColor, strokeColor, lineWidth = 2) {
            if (points.length < 3) return;

            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.closePath();

            ctx.fillStyle = fillColor;
            ctx.fill();
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = lineWidth;
            ctx.stroke();
        }

        function drawLine(start, end, color = 'blue', lineWidth = 3) {
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.stroke();
        }

        function drawPoint(point, color = 'black', radius = 4) {
            ctx.beginPath();
            ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
        }

        function render() {
            clearCanvas();

            // 분할된 폴리곤들 그리기
            if (splitPolygons.length > 0) {
                const colors = [
                    { fill: 'rgba(0, 255, 0, 0.3)', stroke: 'green' },
                    { fill: 'rgba(255, 165, 0, 0.3)', stroke: 'orange' }
                ];
                splitPolygons.forEach((poly, index) => {
                    const color = colors[index % colors.length];
                    drawPolygonShape(poly, color.fill, color.stroke, 3);
                });
            } else if (polygon.length > 2) {
                // 원본 폴리곤 그리기
                drawPolygonShape(polygon, 'rgba(255, 0, 0, 0.3)', 'red');
            }

            // 그리는 중인 폴리곤의 점들
            if (isDrawingPolygon) {
                polygon.forEach(point => drawPoint(point, 'red'));
                if (polygon.length > 0) {
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(polygon[0].x, polygon[0].y);
                    for (let i = 1; i < polygon.length; i++) {
                        ctx.lineTo(polygon[i].x, polygon[i].y);
                    }
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // 분할선 그리기
            if (splitLine) {
                drawLine(splitLine.start, splitLine.end, 'blue', 4);
                drawPoint(splitLine.start, 'blue');
                drawPoint(splitLine.end, 'blue');
            }

            // 그리는 중인 분할선
            if (isDrawingLine && lineStart) {
                drawPoint(lineStart, 'blue');
            }
        }

        // 이벤트 리스너들
        canvas.addEventListener('click', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const point = { x, y };

            if (mode === 'polygon') {
                if (polygon.length > 2 && distance(point, polygon[0]) < 15) {
                    // 폴리곤 완성
                    isDrawingPolygon = false;
                    drawLineBtn.disabled = false;
                    drawPolygonBtn.disabled = true;
                    status.textContent = '폴리곤이 완성되었습니다. 분할선을 그려주세요.';
                    mode = 'none';
                } else {
                    polygon.push(point);
                    if (polygon.length === 1) {
                        status.textContent = '계속 클릭해서 폴리곤을 그리고, 시작점을 다시 클릭해서 완성하세요.';
                    }
                }
            } else if (mode === 'line') {
                if (!lineStart) {
                    lineStart = point;
                    status.textContent = '분할선의 끝점을 클릭하세요.';
                } else {
                    splitLine = { start: lineStart, end: point };
                    lineStart = null;
                    isDrawingLine = false;
                    splitPolygonBtn.disabled = false;
                    drawLineBtn.disabled = true;
                    status.textContent = '분할 실행 버튼을 클릭하세요.';
                    mode = 'none';
                }
            }

            render();
        });

        // 버튼 이벤트들
        drawPolygonBtn.addEventListener('click', function() {
            mode = 'polygon';
            isDrawingPolygon = true;
            polygon = [];
            splitPolygons = [];
            splitLine = null;
            status.textContent = '캔버스를 클릭해서 폴리곤의 꼭짓점을 만드세요.';
            drawLineBtn.disabled = true;
            splitPolygonBtn.disabled = true;
            resultDiv.style.display = 'none';
            render();
        });

        drawLineBtn.addEventListener('click', function() {
            mode = 'line';
            isDrawingLine = true;
            lineStart = null;
            status.textContent = '분할선의 시작점을 클릭하세요.';
            splitPolygonBtn.disabled = true;
        });

        splitPolygonBtn.addEventListener('click', function() {
            if (polygon.length > 2 && splitLine) {
                console.log('분할 시도 중...');
                console.log('폴리곤:', polygon);
                console.log('분할선:', splitLine);
                
                const result = splitPolygonByLine(polygon, splitLine);
                if (result && result.length === 2 && result[0].length >= 3 && result[1].length >= 3) {
                    splitPolygons = result;
                    resultText.textContent = `폴리곤이 ${result.length}개로 성공적으로 분할되었습니다! (폴리곤1: ${result[0].length}개 점, 폴리곤2: ${result[1].length}개 점)`;
                    resultDiv.style.display = 'block';
                    status.textContent = '분할 완료! 새로운 폴리곤을 만들거나 초기화하세요.';
                    splitPolygonBtn.disabled = true;
                    drawPolygonBtn.disabled = false;
                } else {
                    console.log('분할 실패:', result);
                    alert('분할선이 폴리곤을 정확히 가로지르지 않습니다.\n\n팁:\n- 분할선이 폴리곤의 경계선과 정확히 2개의 점에서 만나야 합니다\n- 분할선이 폴리곤을 완전히 관통해야 합니다\n- 꼭짓점이 아닌 변의 중간 부분을 지나가도록 그려보세요');
                    status.textContent = '분할 실패. 분할선이 폴리곤의 변을 2곳에서 가로지르도록 다시 그려주세요.';
                    drawLineBtn.disabled = false;
                    splitLine = null;
                }
                render();
            }
        });

        clearBtn.addEventListener('click', function() {
            polygon = [];
            splitLine = null;
            splitPolygons = [];
            lineStart = null;
            mode = 'none';
            isDrawingPolygon = false;
            isDrawingLine = false;
            
            drawPolygonBtn.disabled = false;
            drawLineBtn.disabled = true;
            splitPolygonBtn.disabled = true;
            
            status.textContent = '모든 것이 초기화되었습니다. 폴리곤 그리기를 시작하세요.';
            resultDiv.style.display = 'none';
            render();
        });

        // 초기 렌더링
        render();
    </script>
</body>
</html>